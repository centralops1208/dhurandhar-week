<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dhurandhar Week â€“ AOM Leaderboard</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body{font-family:system-ui,Arial;margin:20px;background-color:#000042}

    h2{
      margin:0 0 10px 0;
      text-align:center;
      font-size:32px;
      color:#ffffff;
    }

    .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    input,select,button{
      padding:10px;border:1px solid #ddd;border-radius:10px;
      font-size:14px;background:#fff;
    }
    input{width:300px}
    button{cursor:pointer}
    button.active{border-color:#111;font-weight:700}
    .meta{margin-left:auto;font-size:13px;color:#fff;display:flex;gap:12px}

    table{border-collapse:collapse;width:100%;background:#fff;margin-top:10px}
    th,td{border:1px solid #eee;padding:10px;text-align:left;vertical-align:middle}
    th{cursor:pointer;background:#f5f5f5;position:sticky;top:0}
    tr:hover{background:#f9f9f9}

    tr.gold{background:#fff8d1}
    tr.silver{background:#f3f5f7}
    tr.bronze{background:#ffe7d6}

    /* Photo column */
    th.photoHead, td.photoCell{
      width:110px;
      text-align:center;
    }

    .photoBox{
      width:100%;
      max-width:110px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Responsive image:
       - fixed height for table consistency
       - auto width
       - never overflow cell
    */
    .aomImg{
      height:85px;
      width:auto;
      max-width:100%;
      border-radius:16px;
      object-fit:cover;
      border:1px solid #ddd;
      background:#fff;
      display:block;
    }

    /* Mobile: reduce photo size */
    @media (max-width: 600px){
      th.photoHead, td.photoCell{width:90px}
      .photoBox{max-width:90px}
      .aomImg{height:64px}
      input{width:100%}
      .meta{margin-left:0}
    }
  </style>
</head>

<body>
  <h2>ðŸ”¥ Dhurandhar Week â€“ AOM Leaderboard</h2>

  <div class="top">
    <input id="search" placeholder="Search AOM / Circleâ€¦" />
    <select id="circle">
      <option value="">All Circles</option>
    </select>

    <button id="btnAll" class="active" type="button">All</button>
    <button id="btn10" type="button">Top 10</button>
    <button id="btn50" type="button">Top 50</button>

    <div class="meta">
      <span id="count">Loadingâ€¦</span>
      <span id="updated">Last updated: â€”</span>
    </div>
  </div>

  <table id="table">
    <thead></thead>
    <tbody></tbody>
  </table>

<script>
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vRUkfZBtB8_vCdr2eD5qh5GJWwuXyrvreI66slaXScut5SS118EUJnC671Pcy4ebpc_g9dZ3D3xpAO-/pub?gid=1312436288&single=true&output=csv";

let rows = [], headers = [];
let sortCol = 0;
let circleCol = "";
let limitMode = "all"; // all | top10 | top50
let photoCol = ""; // resolved after load

function toNumber(v){
  const n = Number(String(v ?? "").replace('%','').replace(/,/g,'').trim());
  return Number.isFinite(n) ? n : 0;
}

function setActive(id){
  ["btnAll","btn10","btn50"].forEach(b=>{
    document.getElementById(b).classList.toggle("active", b===id);
  });
}

function setUpdated(){
  document.getElementById("updated").innerText =
    "Last updated: " + new Date().toLocaleString();
}

function getData(){
  const q = document.getElementById("search").value.toLowerCase().trim();
  const c = document.getElementById("circle").value;

  let data = rows.filter(r => {
    const searchOk = !q || Object.values(r).some(v => String(v).toLowerCase().includes(q));
    const circleOk = !c || (circleCol && String(r[circleCol]) === c);
    return searchOk && circleOk;
  });

  const col = headers[sortCol];
  data.sort((a,b)=> toNumber(b[col]) - toNumber(a[col]));

  if(limitMode==="top10") data = data.slice(0,10);
  if(limitMode==="top50") data = data.slice(0,50);

  return data;
}

function render(){
  const data = getData();
  document.getElementById("count").innerText = `${data.length} shown`;

  const tbody = document.querySelector("#table tbody");
  tbody.innerHTML = "";

  data.forEach((r,i)=>{
    const tr = document.createElement("tr");

    // Medal background only for Top10/Top50
    if(limitMode!=="all"){
      if(i<10) tr.classList.add("gold");
      else if(i<20) tr.classList.add("silver");
      else if(i<30) tr.classList.add("bronze");
    }

    // --- NEW PHOTO COLUMN FIRST ---
    const photoTd = document.createElement("td");
    photoTd.className = "photoCell";
    const box = document.createElement("div");
    box.className = "photoBox";

    const url = photoCol ? String(r[photoCol] ?? "").trim() : "";
    if(url){
      const img = document.createElement("img");
      img.className = "aomImg";
      img.src = url;
      img.alt = "AOM Photo";
      img.loading = "lazy";
      box.appendChild(img);
    }
    photoTd.appendChild(box);
    tr.appendChild(photoTd);

    // --- REST OF THE COLUMNS (excluding Photo column from sheet) ---
    headers.forEach(h=>{
      if(String(h).toLowerCase() === "photo") return; // hide Photo column itself

      const td = document.createElement("td");
      const val = r[h] ?? "";

      // Ranking medals for Top 3
      if(String(h).toLowerCase().includes("ranking")){
        if(i===0) td.textContent = `ðŸ¥‡ ${val}`;
        else if(i===1) td.textContent = `ðŸ¥ˆ ${val}`;
        else if(i===2) td.textContent = `ðŸ¥‰ ${val}`;
        else td.textContent = val;
      } else {
        td.textContent = val;
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

function buildHeader(){
  const thead = document.querySelector("#table thead");
  thead.innerHTML = "";

  const tr = document.createElement("tr");

  // NEW header for photo column
  const thPhoto = document.createElement("th");
  thPhoto.textContent = "Photo";
  thPhoto.className = "photoHead";
  tr.appendChild(thPhoto);

  // Existing headers (excluding Photo)
  headers.forEach((h,i)=>{
    if(String(h).toLowerCase() === "photo") return;

    const th = document.createElement("th");
    th.textContent = h + (i===sortCol ? " â–¼" : "");
    th.onclick = ()=>{ sortCol=i; buildHeader(); render(); };
    tr.appendChild(th);
  });

  thead.appendChild(tr);
}

Papa.parse(CSV_URL,{
  download:true,
  header:true,
  skipEmptyLines:true,
  complete:(res)=>{
    rows = res.data || [];
    headers = res.meta?.fields || [];

    // resolve column names
    const achIndex = headers.findIndex(h => String(h).toLowerCase().includes("ach"));
    if(achIndex >= 0) sortCol = achIndex;

    circleCol = headers.find(h => String(h).toLowerCase().includes("circle")) || "";
    photoCol  = headers.find(h => String(h).toLowerCase() === "photo") || "";

    buildHeader();
    setUpdated();

    // Fill circle dropdown
    if(circleCol){
      const circles = [...new Set(rows.map(r => r[circleCol]).filter(Boolean))].sort();
      circles.forEach(v=>{
        const o = document.createElement("option");
        o.value=v; o.textContent=v;
        document.getElementById("circle").appendChild(o);
      });
    }

    render();
  }
});

document.getElementById("search").addEventListener("input", render);
document.getElementById("circle").addEventListener("change", render);

document.getElementById("btnAll").onclick = ()=>{ limitMode="all"; setActive("btnAll"); render(); };
document.getElementById("btn10").onclick  = ()=>{ limitMode="top10"; setActive("btn10"); render(); };
document.getElementById("btn50").onclick  = ()=>{ limitMode="top50"; setActive("btn50"); render(); };
</script>
</body>
</html>
